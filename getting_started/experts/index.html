
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The documentation for the EvoProtGrad library.">
      
      
        <meta name="author" content="Patrick Emami">
      
      
        <link rel="canonical" href="https://nrel.github.io/EvoProtGrad/getting_started/experts/">
      
      
        <link rel="prev" href="../Trying_out_EvoProtGrad/">
      
      
        <link rel="next" href="../MCMC/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>Experts - EvoProtGrad</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#what-is-a-product-of-experts" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="EvoProtGrad" class="md-header__button md-logo" aria-label="EvoProtGrad" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EvoProtGrad
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Experts
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/NREL/EvoProtGrad/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    NREL/EvoProtGrad
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="EvoProtGrad" class="md-nav__button md-logo" aria-label="EvoProtGrad" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EvoProtGrad
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NREL/EvoProtGrad/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    NREL/EvoProtGrad
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Trying_out_EvoProtGrad/" class="md-nav__link">
        Trying out EvoProtGrad
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Experts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Experts
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-a-product-of-experts" class="md-nav__link">
    What is a Product of Experts?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#huggingface-transformers" class="md-nav__link">
    🤗 HuggingFace Transformers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evcouplings-potts" class="md-nav__link">
    EVcouplings Potts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downstream-regression" class="md-nav__link">
    Downstream Regression
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choosing-the-expert-temperature" class="md-nav__link">
    Choosing the Expert Temperature
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MCMC/" class="md-nav__link">
        Gradient-based Discrete MCMC for Directed Evolution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tokenizers/" class="md-nav__link">
        Tokenizers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/evo_prot_grad/" class="md-nav__link">
        evo_prot_grad
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/" class="md-nav__link">
        evo_prot_grad.models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/experts/" class="md-nav__link">
        evo_prot_grad.experts
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          evo_prot_grad.common
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          evo_prot_grad.common
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/common/embeddings/" class="md-nav__link">
        evo_prot_grad.common.embeddings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/common/sampler/" class="md-nav__link">
        evo_prot_grad.common.sampler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/common/tokenizers/" class="md-nav__link">
        evo_prot_grad.common.tokenizers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/common/utils/" class="md-nav__link">
        evo_prot_grad.common.utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Experts</h1>

<p>In EvoProtGrad, an expert has a tokenizer for converting lists of strings into Torch one-hot tensors and a differentiable model that takes as input a one-hot-encoded protein sequence and returns a score. The idea is to combine multiple experts together for directed evolution, since some experts may correlate with the desired attribute(s) you wish to optimize while other experts help steer search away from deleterious mutations. We provide a few  experts in <code>evo_prot_grad/experts</code> that you can use out of the box, such as:</p>
<p>Protein Language Models (PLMs)</p>
<ul>
<li><code>bert</code>, BERT-style PLMs, default: <code>Rostlab/prot_bert</code></li>
<li><code>causallm</code>, CausalLM-style PLMs, default: <code>lightonai/RITA_s</code></li>
<li><code>esm</code>, ESM-style PLMs, default: <code>facebook/esm2_t6_8M_UR50D</code></li>
</ul>
<p>Potts models</p>
<ul>
<li><code>evcouplings</code></li>
</ul>
<p>and an generic expert for supervised downstream regression models</p>
<ul>
<li><code>onehot_downstream_regression</code></li>
</ul>
<h2 id="what-is-a-product-of-experts">What is a Product of Experts?<a class="headerlink" href="#what-is-a-product-of-experts" title="Permanent link"></a></h2>
<p><code>EvoProtGrad</code> combines multiple experts into a Product of Experts.
Formally, each expert defines a (typically unnormalized) probability distribution over protein sequences. High probability can correspond to high fitness or high <a href="https://www.nature.com/articles/s41587-021-01146-5">evolutionary density</a>. 
A Product of Experts is the product of these distributions, normalized by an unknown partition function <span class="arithmatex">\(Z\)</span>.
For example, if we have two experts <span class="arithmatex">\(F\)</span> and <span class="arithmatex">\(G\)</span>, the Product of Experts is:</p>
<div class="arithmatex">\[
P(X) = \frac{1}{Z}  F(X) G(X)^{\lambda}
\]</div>
<p>where <span class="arithmatex">\(F(X)\)</span> may correspond to the probability given by an unsupervised pretrained PLM to sequence <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(G(X)\)</span> may correspond to the probability assigned to <span class="arithmatex">\(X\)</span> by a supervised downstream regression model (interpreted as an unnormalized Boltzmann distribution with temperature <span class="arithmatex">\(\lambda\)</span>). We can compute the sum of the (log) probabilities of the experts as follows:</p>
<div class="arithmatex">\[
\log P(X) = \log F(X) - \lambda \log G(X) - \log Z.
\]</div>
<p>In <code>EvoProtGrad</code>, the "score" of each expert corresponds to either <span class="arithmatex">\(\log F(X)\)</span> or <span class="arithmatex">\(\log G(X)\)</span> here. In most cases, we interpret the scalar output of a neural network as the score.
The magic of the Product of Experts formulation is that it enables us to compose arbitrary numbers of experts, essentially allowing us to "plug and play" with different experts to guide the search.</p>
<p>In actuality, instead of just searching for a protein variant that maximizes <span class="arithmatex">\(P(X)\)</span>, <code>EvoProtGrad</code> uses gradient-based discrete MCMC to <em>sample</em> from <span class="arithmatex">\(P(X)\)</span>.
MCMC is necessary for sampling from <span class="arithmatex">\(P(X)\)</span> because it is impractical to compute the partition function <span class="arithmatex">\(Z\)</span> exactly.
Uniquely to <code>EvoProtGrad</code>, as long <em>all</em> experts are <em>differentiable</em>, our sampler can use the gradient of <span class="arithmatex">\(\log F(X) - \lambda \log G(X)\)</span> with respect to the one-hot protein <span class="arithmatex">\(X\)</span> to identify the most promising mutation to apply to <span class="arithmatex">\(X\)</span>, which vastly speeds up MCMC convergence.</p>
<h2 id="huggingface-transformers">🤗 HuggingFace Transformers<a class="headerlink" href="#huggingface-transformers" title="Permanent link"></a></h2>
<p><code>EvoProtGrad</code> provides a convenient interface for defining and using experts from the HuggingFace Hub.
To use pretrained PLMs from the HuggingFace Hub with gradient-based discrete MCMC, we swap out each transformer's token embedding layer for a custom <a href="https://nrel.github.io/EvoProtGrad/api/common/embeddings/#onehotembedding">one-hot token embedding layer</a>. This enables us to compute and access gradients with respect to one-hot input protein sequences.</p>
<p>We provide a baseclass <code>evo_prot_grad.experts.base_experts.HuggingFaceExpert</code> which is subclassed to support various types of HuggingFace PLMs. Currently, we provide three subclasses for</p>
<ul>
<li>BERT-style PLMs (<code>evo_prot_grad.experts.bert_expert.BertExpert</code>)</li>
<li>CausalLM-style PLMs (<code>evo_prot_grad.experts.causallm_expert.CausalLMExpert</code>)</li>
<li>ESM-style PLMs (<code>evo_prot_grad.experts.esm_expert.EsmExpert</code>)</li>
</ul>
<p>Each HuggingFace PLM expert has to specify the model and tokenizer to use. We provide defaults for each type of PLM. 
For example, an ESM2 expert can be instantiated with only:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">esm2_expert</span> <span class="o">=</span> <span class="n">evo_prot_grad</span><span class="o">.</span><span class="n">get_expert</span><span class="p">(</span><span class="s1">&#39;esm&#39;</span><span class="p">,</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>with default model <code>EsmForMaskedLM.from_pretrained("facebook/esm2_t6_8M_UR50D")</code> and tokenizer <code>AutoTokenizer.from_pretrained("facebook/esm2_t6_8M_UR50D")</code>.
With custom model and tokenizer:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">EsmForMaskedLM</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">esm2_expert</span> <span class="o">=</span> <span class="n">evo_prot_grad</span><span class="o">.</span><span class="n">get_expert</span><span class="p">(</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>                <span class="s1">&#39;esm&#39;</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">EsmForMaskedLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;facebook/esm2_t33_650M_UR50D&quot;</span><span class="p">),</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>                <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;facebook/esm2_t33_650M_UR50D&quot;</span><span class="p">),</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>                <span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>                <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="evcouplings-potts">EVcouplings Potts<a class="headerlink" href="#evcouplings-potts" title="Permanent link"></a></h2>
<p>Potts models are (differentiable) linear undirected graphical models that capture pairwise interactions between amino acids in a protein sequence. 
They are fit to multiple sequence alignments (MSAs) of homologous sequences and can be used to score the evolutionary density of a sequence with respect to the MSA via the <em>Hamiltonian</em> score. 
The Hamiltonian score <a href="https://www.nature.com/articles/s41587-021-01146-5">has been demonstrated</a> to be a good proxy for the fitness of a variant.
We provide an expert that wrap Potts models from the <a href="https://github.com/debbiemarkslab/EVcouplings">debbiemarkslab/EVcouplings</a> library.</p>
<p>The EVcouplings expert expects an EVcouplings model <code>evo_prot_grad.models.EVCouplings</code> (which is a PyTorch re-implementation of the EVcouplings <code>Couplings</code> Potts model), whose parameters we initialize from a file in "plmc_v2" format produced by the <code>debbiemarkslab/plmc</code> library.</p>
<p>Example:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">evcouplings_model</span> <span class="o">=</span> <span class="n">EVCouplings</span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>            <span class="n">model_params_file</span> <span class="o">=</span> <span class="s1">&#39;GFP_AEQVI_Sarkisyan2016-linear-15/plmc/uniref100.model_params&#39;</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>            <span class="n">fasta_file</span> <span class="o">=</span> <span class="s1">&#39;test/gfp.fasta&#39;</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">evcouplings_expert</span> <span class="o">=</span> <span class="n">get_expert</span><span class="p">(</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>            <span class="s1">&#39;evcouplings&#39;</span><span class="p">,</span> 
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">evcouplings_model</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="downstream-regression">Downstream Regression<a class="headerlink" href="#downstream-regression" title="Permanent link"></a></h2>
<p>We provide a generic expert for supervised downstream regression models and a simple 1D-Convolutional neural network (CNN) PyTorch Module (<code>evo_prot_grad.models.OneHotCNN</code>) that predicts a scalar fitness score from a one-hot-encoded protein sequence.</p>
<p>To get started, we provide a pretrained OneHotCNN model trained on the <a href="https://datadryad.org/stash/dataset/doi:10.6078/D1K71B">Green Fluorescent Protein (GFP) dataset</a> that can be loaded from the HuggingFace Hub:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">onehotcnn_model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>            <span class="s1">&#39;NREL/avGFP-fluorescence-onehot-cnn&#39;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">regression_expert</span> <span class="o">=</span> <span class="n">get_expert</span><span class="p">(</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>            <span class="s1">&#39;onehot_downstream_regression&#39;</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">onehotcnn_model</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="training-your-own-downstream-regression-model">Training your own downstream regression model<a class="headerlink" href="#training-your-own-downstream-regression-model" title="Permanent link"></a></h3>
<p>You can train a <code>OneHotCNN</code> (or your own custom PyTorch model) as you normally would any supervised regression model with a dataset of pairs of (variants, fitness/stability/etc.) labels. We provide a default tokenizer class <a href="https://nrel.github.io/EvoProtGrad/api/common/tokenizers"><code>OneHotTokenizer</code></a> that can be used to convert a list of strings of amino acids into Torch one-hot tensors. Then, you can use the trained model as an expert in <code>EvoProtGrad</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Load your trained model</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">onehotcnn_model</span> <span class="o">=</span> <span class="n">OneHotCNN</span><span class="p">()</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">onehotcnn_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;onehotcnn.pt&#39;</span><span class="p">))</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">regression_expert</span> <span class="o">=</span> <span class="n">get_expert</span><span class="p">(</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>            <span class="s1">&#39;onehot_downstream_regression&#39;</span><span class="p">,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">onehotcnn_model</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="choosing-the-expert-temperature">Choosing the Expert Temperature<a class="headerlink" href="#choosing-the-expert-temperature" title="Permanent link"></a></h2>
<p>The expert temperature <span class="arithmatex">\(\lambda\)</span> controls the relative importance of the expert in the Product of Experts. By default it is set to 1. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, the expert's score for a variant is normalized by the wild type score, i.e., we subtract the wild type score from the variant score. This is to ensure that each expert in the Product of Experts is centered around 0. If you want to use the raw expert score, set <code>use_without_wildtype = True</code> when instantiating the expert.</p>
</div>
<p>If using wild type centering, then we recommend first trying temperatures of 1.0 for each <span class="arithmatex">\(\lambda\)</span>. 
We describe a simple heuristic for selecting <span class="arithmatex">\(\lambda\)</span> via a grid search using a small dataset of labeled variants in Section 5.2 of our <a href="https://doi.org/10.1088/2632-2153/accacd">paper</a>.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "toc.integrate", "header.autohide"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a51614de.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>